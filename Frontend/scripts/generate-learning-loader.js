const fs = require('fs')
const path = require('path')

const DATA_DIR = path.join(__dirname, '..', 'data')
const MODULES = ['aptitude', 'reasoning', 'verbal', 'python']
const ACTIONS = ['study', 'exercise', 'assignment', 'coding']

const LABEL_OVERRIDES = {
  'lcm-hcf-concepts': 'LCM & HCF (Concepts)',
  'lcm-hcf-apps': 'LCM & HCF (Applications)',
  'percentages-basics': 'Percentages',
  'profit-loss-basics': 'Profit & Loss',
  si: 'Simple Interest',
  ci: 'Compound Interest',
  'ratios-basics': 'Ratios & Proportions',
  'mixtures-basics': 'Mixtures & Alligations',
  'partnerships-basics': 'Partnerships',
  'ages-basics': 'Ages',
  'averages-basics': 'Averages',
  'tsd-basics': 'Time, Speed & Distance',
  'time-work-basics': 'Time & Work',
  'perm-comb-basics': 'Permutations & Combinations',
  'probability-basics': 'Probability',
  'company-mcq-ns': 'Company-Specific MCQs',
  'aptitude-final': 'Final Assessment',
  powercycles: 'Power Cycles',
  'reasoning-final': 'Final Assessment',
  'verbal-final': 'Final Assessment',
  'intro-python': 'Introduction to Python',
  'io-basics': 'I/O Basics',
  'operators-conditionals': 'Operators & Conditional Statements',
  'nested-conditions': 'Nested Conditions',
  'loop-control': 'Loop Control Statements',
  'strings-variables': 'Strings & Variables',
  'clock-1': 'Clock 1',
  'clock-2': 'Clock 2',
  'clock-3': 'Clock 3',
  'company-mcq-clocks': 'Company-Specific MCQs',
  'calendars-basics': 'Calendars',
  'di-basics': 'Data Interpretation',
  'ranking-basics': 'Ranking',
  'directions-basics': 'Directions',
  'coding-basics': 'Coding & Decoding',
  'data-arr-basics': 'Data Arrangements',
  'blood-basics': 'Blood Relations',
  'venn-basics': 'Venn Diagrams',
  'syllogisms-basics': 'Syllogisms',
  'cubes-basics': 'Cubes',
  'puzzles-basics': 'Puzzles',
  'ds-basics': 'Data Sufficiency',
  'rc-basics': 'Reading Comprehension',
  'sc-basics': 'Sentence Correction',
  'error-basics': 'Error Spotting',
  'fill-basics': 'Fill in the Blanks',
  'para-basics': 'Para Jumbles',
  'syn-basics': 'Synonyms & Antonyms',
  'vocab-basics': 'Vocabulary',
  'voice-basics': 'Active & Passive Voice',
  'speech-basics': 'Direct & Indirect Speech',
  'cloze-basics': 'Cloze Test',
  'verbal-company-mcq': 'Company-Specific MCQs',
}

function labelFromId(topicId) {
  if (LABEL_OVERRIDES[topicId]) return LABEL_OVERRIDES[topicId]
  return topicId
    .split('-')
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ')
}

function hasAction(modulePath, topicId, action) {
  const base = path.join(modulePath, topicId)
  const hasFile = (name) => fs.existsSync(path.join(base, name))
  const hasDir = (name) => fs.existsSync(path.join(base, name)) && fs.existsSync(path.join(base, name, 'index.ts'))
  if (action === 'coding') {
    return hasFile('coding.ts') || hasDir('coding')
  }
  return hasFile(action + '.ts') || hasDir(action)
}

function scanModule(moduleId) {
  const modulePath = path.join(DATA_DIR, moduleId)
  if (!fs.existsSync(modulePath) || !fs.statSync(modulePath).isDirectory()) {
    return []
  }
  const topicIds = fs
    .readdirSync(modulePath, { withFileTypes: true })
    .filter((d) => d.isDirectory() && !d.name.startsWith('.') && d.name !== 'generated')
    .map((d) => d.name)
  const configs = []
  for (const topicId of topicIds) {
    const actions = []
    if (hasAction(modulePath, topicId, 'study')) actions.push('study')
    if (hasAction(modulePath, topicId, 'exercise')) actions.push('exercise')
    if (hasAction(modulePath, topicId, 'assignment')) actions.push('assignment')
    if (moduleId === 'python' && hasAction(modulePath, topicId, 'coding')) actions.push('coding')
    if (actions.length === 0) continue
    configs.push({
      moduleId,
      topicId,
      label: labelFromId(topicId),
      actions,
    })
  }
  return configs.sort((a, b) => a.topicId.localeCompare(b.topicId))
}

function safeVarName(moduleId, topicId, action) {
  const t = topicId.replace(/-/g, '_')
  const m = moduleId.slice(0, 2)
  return `_${m}_${t}_${action}`
}

function generateLoader(allConfigs) {
  const lines = [
    '// AUTO-GENERATED by scripts/generate-learning-loader.js — do not edit',
    "import type { ModuleNode } from './types'",
    '',
  ]
  const studyEntries = []
  const exerciseEntries = []
  const assignmentEntries = []

  for (const c of allConfigs) {
    for (const action of c.actions) {
      if (action === 'coding') continue
      const varName = safeVarName(c.moduleId, c.topicId, action)
      const importPath = `./${c.moduleId}/${c.topicId}/${action}`
      lines.push(`import * as ${varName} from '${importPath}'`)
      const key = `${c.topicId}-${action}`
      const content = `Object.values(${varName})[0]`
      if (action === 'study') studyEntries.push([key, content])
      if (action === 'exercise') exerciseEntries.push([key, content])
      if (action === 'assignment') assignmentEntries.push([key, content])
    }
  }

  lines.push('')
  lines.push('const TOPIC_CONFIG = [')
  for (const c of allConfigs) {
    lines.push(`  { moduleId: '${c.moduleId}', topicId: '${c.topicId}', label: ${JSON.stringify(c.label)}, actions: ${JSON.stringify(c.actions)} },`)
  }
  lines.push('] as const')
  lines.push('')
  lines.push('function buildModuleTree(moduleId: string, moduleLabel: string): ModuleNode {')
  lines.push('  const topics = TOPIC_CONFIG.filter((c) => c.moduleId === moduleId)')
  lines.push('  const children: ModuleNode[] = topics.map((t) => ({')
  lines.push('    id: t.topicId,')
  lines.push('    label: t.label,')
  lines.push('    children: t.actions.map((a) => {')
  lines.push("      const id = `${t.topicId}-${a}`")
  lines.push('      const meta = a === \'study\' ? undefined : a === \'exercise\' ? \'10 Questions\' : a === \'assignment\' ? \'20 MCQs\' : \'2 Questions\'')
  lines.push('      const label = a === \'study\' ? \'Study Material\' : a === \'exercise\' ? \'Basic Exercise (10 Questions)\' : a === \'assignment\' ? \'Assignment (20 MCQs)\' : \'Coding Practice (2 Questions – Interview POV)\'')
  lines.push('      return { id, label, type: a as ModuleNode[\'type\'], meta }')
  lines.push('    }),')
  lines.push('  }))')
  lines.push('  return { id: moduleId, label: moduleLabel, children }')
  lines.push('}')
  lines.push('')
  lines.push('export const aptitudeModule = buildModuleTree(\'aptitude\', \'Quantitative Aptitude\')')
  lines.push('export const reasoningModule = buildModuleTree(\'reasoning\', \'Logical Reasoning\')')
  lines.push('export const verbalModule = buildModuleTree(\'verbal\', \'Verbal Ability\')')
  lines.push('export const pythonModule = buildModuleTree(\'python\', \'Python Programming\')')
  lines.push('')
  lines.push('export function getLearningModules(): { aptitude: ModuleNode; reasoning: ModuleNode; verbal: ModuleNode; python: ModuleNode } {')
  lines.push('  return { aptitude: aptitudeModule, reasoning: reasoningModule, verbal: verbalModule, python: pythonModule }')
  lines.push('}')
  lines.push('')
  lines.push('export const studyContentMap: Record<string, any> = {')
  for (const [k, v] of studyEntries) {
    lines.push(`  '${k}': ${v},`)
  }
  lines.push('}')
  lines.push('')
  lines.push('export const exerciseContentMap: Record<string, any> = {')
  for (const [k, v] of exerciseEntries) {
    lines.push(`  '${k}': ${v},`)
  }
  lines.push('}')
  lines.push('')
  lines.push('export const assignmentContentMap: Record<string, any> = {')
  for (const [k, v] of assignmentEntries) {
    lines.push(`  '${k}': ${v},`)
  }
  lines.push('}')
  lines.push('')

  return lines.join('\n')
}

function main() {
  const allConfigs = []
  for (const moduleId of MODULES) {
    const configs = scanModule(moduleId)
    allConfigs.push(...configs)
  }
  const out = path.join(DATA_DIR, 'loader.generated.ts')
  fs.writeFileSync(out, generateLoader(allConfigs), 'utf8')
  console.log('Wrote', out, '—', allConfigs.length, 'topics')
}

main()
